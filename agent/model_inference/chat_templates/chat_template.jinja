{# Default role mappings #}
{%- set roles = roles | default({
    "user": "user",
    "system": "system",
    "assistant": "assistant",
    "tool": "tool"
}) -%}

{# Token definitions #}
{%- set start_header_token = start_header_token | default("<|start_header_id|>") -%}
{%- set end_header_token = end_header_token | default("<|end_header_id|>") -%}
{%- set eom_token = eom_token | default(eos_token) if eom_token | default("") == "" -%}

{# Tool-related tokens #}
{%- set tool_use_start = tool_use_start | default("```json\n") -%}
{%- set tool_use_end = tool_use_end | default("\n```") -%}
{%- set tool_result_start = tool_result_start | default(start_header_token + roles.tool + end_header_token + "\n\n") -%}
{%- set tool_result_end = tool_result_end | default(eos_token) -%}

{%- set add_generation_prompt = add_generation_prompt | default(true) -%}
{%- set prefill = prefill | default(none) -%}
{%- set system_reminder = system_reminder | default("") -%}

{# ------------------------------------------------------------------------ #}
{# Macro to render individual events                                        #}
{# ------------------------------------------------------------------------ #}
{%- macro render_event(event) -%}

    {%- set role = roles.get(event['state'], event['state']) -%}
    {{- start_header_token + role + end_header_token + "\n\n" -}}
    {{- event['content'] | safe -}}

    {%- for tool_call in event.tool_calls -%}
        {{- tool_use_start }}
        {%- set function = tool_call.function -%}
        {{- function | tojson(indent=2) | trim -}}
        {{- tool_use_end -}}

        {%- if tool_call.tool_use_id in events -%}
            {{- eom_token -}}
            {{- tool_result_start -}}
            {{- events[tool_call.tool_use_id].content | safe -}}
            {{- tool_result_end -}}
            {%- if not loop.last -%}
                {{- start_header_token + role + end_header_token + "\n\n" -}}
            {%- endif -%}
        {%- endif -%}
    {%- endfor -%}
    {{- eos_token -}}
{%- endmacro -%}


{# ------------------------------------------------------------------------ #}
{# Chat template                                                            #}
{# ------------------------------------------------------------------------ #}
{{- bos_token -}}

{%- if events is defined -%}
    {%- for event in events.values() -%}
    {%- if event.get("content", "").strip() or (event.tool_calls and event.tool_calls | length > 0) -%}
        {{ render_event(event) -}}
    {%- endif -%}
{%- endfor -%}
{%- elif prompt is defined -%}
    {%- for event in prompt -%}
        {{ render_event(event) -}}
    {%- endfor -%}
{%- elif messages is defined -%}
    {%- for event in messages -%}
        {{ render_event(event) -}}
    {%- endfor -%}
{%- endif -%}

{%- if system_reminder is defined and system_reminder != "" -%}
    {{- system_reminder -}}
{%- endif -%}

{%- if add_generation_prompt -%}
    {{- start_header_token + roles.assistant + end_header_token + "\n\n" -}}
{%- endif -%}

{%- if prefill -%}
    {{- prefill -}}
{%- endif -%}
